
#include <unistd.h>
#include <sys/time.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdbool.h>
#include <pthread.h>
#include "leds.h"
#include "usart.h"
#include "sdcard_diskio.h"
#include "logger.h"
#include "systime.h"


// 8192 characters
const char test_data_set[] =
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
        "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234";

typedef struct {
    char* filename;
    char* mode;
    char*data;
    unsigned long length;
    unsigned long iterations;
    unsigned long blocks;
    float max;
    float min;
    float average;
    float kBps;
} test_data_t;

char test_buffer[32768];

disk_interface_t sddisk;

test_data_t test_data[] = {
        {"write.txt", "write", (char*)test_data_set, 1,    3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1,    3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1,    3, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1,    3, 1000000,  0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 10,   3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 10,   3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 10,   3, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 10,   3, 1000000,  0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 100,  3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 100,  3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 100,  3, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1000, 3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1000, 3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1000, 1, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1024, 3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1024, 3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 1024, 1, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 4096, 3, 1,        0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 4096, 3, 100,      0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 4096, 1, 1000,     0, 10000000, 0, 0},
        {"write.txt", "write", (char*)test_data_set, 8192, 1, 1000,     0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  1,          3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  10,         3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  100,        3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  1000,       3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  1024,    3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  4096,    3, 100, 0, 10000000, 0, 0},
        {"write.txt", "read", (char*)test_buffer,  32768,    3, 100, 0, 10000000, 0, 0},
        {NULL, NULL, NULL, 0, 0, 0, 0, 0, 0, 0}
};

/**
 * example of an application task
 *
 * this task performs a data logger function, reading data from USART2
 * and logging it to a file.
 */
void test_task()
{
    logger_t log;
    int datafile;
    int mode;
    test_data_t* td;
    unsigned long cycle, iter;
    struct timeval tv1, tv2;
    float t;
    float sum;

    log_init(&log, "test task");
    log_info(&log, "starting application");

    for(td = test_data; td->data; td++)
    {
        if(*td->mode == 'w')
            mode = O_WRONLY|O_CREAT|O_TRUNC;
        else if(*td->mode == 'r')
            mode = O_RDONLY;

        sum = 0;
        for(iter = 0; iter < td->iterations; iter++)
        {
            // fopen is the most convenient method of opening a regular file
            datafile = open(td->filename, mode);

            if(datafile > 0)
            {
                gettimeofday(&tv1, NULL);
                for(cycle = 0; cycle < td->blocks; cycle++)
                {
                    if(*td->mode == 'w')
                        write(datafile, td->data, td->length);
                    else if(*td->mode == 'r')
                        read(datafile, td->data, td->length);
                }
                gettimeofday(&tv2, NULL);

                t = ((((float)tv2.tv_sec*1000000) + (float)tv2.tv_usec) - (((float)tv1.tv_sec*1000000) + (float)tv1.tv_usec)) / 1000000;

                sum += t;

                if(t > td->max)
                    td->max = t;
                if(t < td->min)
                    td->min = t;
            }
            else
                log_error(&log, "error opening %s", td->filename);

            close(datafile);
        }

        td->average = sum/(td->iterations);

        td->kBps = ((float)(td->length * td->blocks) / ((float)1000 * td->average));

        printf("%s\t%u blocks of %u bytes (%.3fkB), %u cycles. tmax=%.4fs, tav=%.4fs,tmin=%.4fs, rate=%.3fkBps\n",
                        td->mode, td->blocks, td->length, (double)td->blocks*(double)td->length/(double)1000, td->iterations,
                        (double)td->max, (double)td->average, (double)td->min, (double)td->kBps);
    }

    pthread_exit(0);
}


int main(void)
{
	// use the system led flasher to flash one of the leds
	flash_led(LED1);

	logger_t log;

	log_init(&log, "main");

	// initialise filesystem
	sdcard_mount(&sddisk, 0);

	// start up the application
    pthread_t app_thread;
	pthread_attr_t app_attr;
	pthread_attr_init(&app_attr);
	pthread_attr_setstacksize(&app_attr, 384);
	pthread_attr_setdetachstate(&app_attr, PTHREAD_CREATE_DETACHED);
	pthread_create(&app_thread, &app_attr, (void*(*)(void*))test_task, NULL);
	pthread_attr_destroy(&app_attr);

	pthread_exit(0);
	return 0;
}
